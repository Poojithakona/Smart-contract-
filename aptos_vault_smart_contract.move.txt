module VaultModule::SimpleVault {
    use aptos_framework::signer;
    use aptos_framework::coin;
    use aptos_framework::aptos_coin::AptosCoin;
    use aptos_framework::account;
    use std::error;
    
    const E_NOT_ADMIN: u64 = 1;
    const E_INSUFFICIENT_BALANCE: u64 = 2;
    const E_VAULT_EXISTS: u64 = 3;


    struct Vault has store, key {
        admin: address,          
        total_balance: u64,       
        vault_address: address,   
    }


    struct VaultSignerCapability has store, key {
        cap: account::SignerCapability,
    }

    
    public entry fun create_vault(admin: &signer) {
        let admin_address = signer::address_of(admin);
        
    
        assert!(!exists<Vault>(admin_address), error::already_exists(E_VAULT_EXISTS));
        
        
        let (vault_signer, vault_signer_cap) = account::create_resource_account(admin, b"vault");
        let vault_address = signer::address_of(&vault_signer);
        
    
        move_to(admin, VaultSignerCapability {
            cap: vault_signer_cap,
        });
        
        
        let vault = Vault {
            admin: admin_address,
            total_balance: 0,
            vault_address,
        };
        move_to(admin, vault);
        
        
        coin::register<AptosCoin>(&vault_signer);
    }

    public entry fun deposit_tokens(admin: &signer, vault_address: address, amount: u64) acquires Vault {
        let admin_address = signer::address_of(admin);
        let vault = borrow_global_mut<Vault>(admin_address);
        
    
        assert!(vault.admin == admin_address, error::permission_denied(E_NOT_ADMIN));
        
    
        coin::transfer<AptosCoin>(admin, vault.vault_address, amount);
        
    
        vault.total_balance = vault.total_balance + amount;
    }


    public entry fun withdraw_tokens(admin: &signer, vault_address: address, amount: u64) acquires Vault, VaultSignerCapability {
        let admin_address = signer::address_of(admin);
        let vault = borrow_global_mut<Vault>(admin_address);
        
        
        assert!(vault.admin == admin_address, error::permission_denied(E_NOT_ADMIN));
        
        
        assert!(vault.total_balance >= amount, error::invalid_argument(E_INSUFFICIENT_BALANCE));
        
    
        let vault_signer_cap = &borrow_global<VaultSignerCapability>(admin_address).cap;
        let vault_signer = account::create_signer_with_capability(vault_signer_cap);
        
    
        coin::transfer<AptosCoin>(&vault_signer, admin_address, amount);
        
        
        vault.total_balance = vault.total_balance - amount;
    }

}
